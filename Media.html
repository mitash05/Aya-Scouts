<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYA Media Drop</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- LUXURY GLASS THEME --- */
        :root {
    /* MATCHING INDEX.HTML DARK MODE */
    --bg-gradient: linear-gradient(135deg, #0f172a, #020617);
    --glass-bg: rgba(30, 41, 59, 0.7);
    --glass-border: rgba(255, 255, 255, 0.1);
    
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    
    --accent-gold: #d97706; /* Matches the "Gold" brand color from Index */
    --success-green: #2ecc71;
    --error-red: #e74c3c;
    --input-bg: rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
}

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        /* --- GLASS CONTAINER --- */
        .main-container {
            width: 100%;
            max-width: 900px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            position: relative;
        }

        /* HEADER */
        header {
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.1);
        }

        .title-wrapper { display: flex; align-items: center; gap: 15px; }
        .header-logo { height: 50px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        
        h1 { 
            margin: 0; 
            font-weight: 300; 
            letter-spacing: 2px; 
            font-size: 1.4rem; 
            text-transform: uppercase; 
        }
        h1 span { font-weight: 700; color: var(--accent-gold); }

        /* FORM LAYOUT */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            padding: 2.5rem;
        }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; gap: 20px; padding: 1.5rem; } }

        label {
            display: block;
            color: var(--accent-gold);
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .helper-text { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; font-style: italic; }

        input, select {
            width: 100%;
            padding: 14px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            box-sizing: border-box;
            transition: 0.3s;
            margin-bottom: 20px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-gold);
            background: rgba(0,0,0,0.4);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }

        /* TOGGLE TABS */
        .mode-toggle {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 25px;
        }
        .mode-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            border-radius: 8px;
            transition: 0.3s;
        }
        .mode-option.active {
            background: var(--glass-border);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* DRIVE BUTTON */
        .btn-drive {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 5px;
        }
        .btn-drive:hover { background: var(--accent-gold); color: #000; }
        .success-link { display: block; text-align: center; margin-top: 10px; color: var(--success-green); text-decoration: none; font-weight: bold; font-size: 0.9rem; }

        /* UPLOAD ZONE */
        .upload-zone {
            margin: 0 2.5rem 2.5rem 2.5rem;
            border: 2px dashed var(--glass-border);
            border-radius: 15px;
            background: rgba(0,0,0,0.1);
            transition: 0.3s;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .upload-zone:hover { background: rgba(255,255,255,0.05); border-color: var(--text-muted); }
        .icon-camera { font-size: 2.5rem; margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }

        /* GALLERY */
        #gallery { 
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; 
            padding: 20px;
        }
        .polaroid {
            width: 100px; height: 100px;
            background: white;
            padding: 5px 5px 25px 5px;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            transform: rotate(-2deg);
            transition: 0.3s;
        }
        .polaroid:nth-child(even) { transform: rotate(2deg); }
        .polaroid img { width: 100%; height: 100%; object-fit: cover; border-radius: 2px; }
        
        /* OVERLAYS */
        .status-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6);
            display: none; align-items: center; justify-content: center;
            border-radius: 4px;
            color: white; font-weight: bold; font-size: 1.5rem;
        }
        .polaroid.success .status-overlay { display: flex; background: rgba(46, 204, 113, 0.8); } /* Green */
        .polaroid.error .status-overlay { display: flex; background: rgba(231, 76, 60, 0.8); } /* Red */

        /* FOOTER / ACTION */
        .action-bar {
            padding: 2rem;
            background: rgba(0,0,0,0.2);
            text-align: center;
        }

        .btn-upload {
            background: linear-gradient(45deg, var(--accent-gold), #f1c40f);
            color: #1a1a1a;
            border: none;
            padding: 16px 60px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-upload:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(212, 175, 55, 0.5); }
        .btn-upload:disabled { background: #555; color: #888; box-shadow: none; cursor: not-allowed; transform: none; }

        /* PROGRESS BAR */
        .progress-container {
            width: 100%; height: 6px; background: rgba(255,255,255,0.1); 
            border-radius: 3px; margin-top: 20px; overflow: hidden; display: none;
        }
        .progress-bar { height: 100%; background: var(--success-green); width: 0%; transition: width 0.3s; }
        #progress-text { margin-top: 10px; font-size: 0.9rem; color: var(--text-muted); }

        /* SHAKE ANIMATION (For wrong password) */
        @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(5px)} 50%{transform:translateX(-5px)} 75%{transform:translateX(5px)} 100%{transform:translateX(0)} }
        .shake { animation: shake 0.3s ease-in-out; border-color: var(--error-red) !important; }

    </style>
</head>
<body>

    <a href="index.html" style="position: absolute; top: 20px; left: 20px; z-index: 100; text-decoration: none; font-size: 24px; background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
    üè†
</a>
    
<div class="main-container">
    <header>
        <div class="title-wrapper">
            <img src="./AYA logo vahanig.png" alt="Logo" class="header-logo">
            <h1>AYA <span>Media Drop</span></h1>
        </div>
    </header>

    <div class="form-grid">
        <div>
            <div class="mode-toggle">
                <div class="mode-option active" id="tab-new" onclick="setMode('new')">New Folder</div>
                <div class="mode-option" id="tab-existing" onclick="setMode('existing')">Existing Folder</div>
            </div>

            <div id="new-folder-group">
                <label>Folder Name</label>
                <input type="text" id="folderNameInput" placeholder="e.g. Mother's Day">
                <label>Date</label>
                <input type="date" id="folderDateInput">
            </div>

            <div id="existing-folder-group" style="display:none;">
                <label>Select Event</label>
                <select id="existingFolderSelect"><option disabled selected>Loading folders...</option></select>
            </div>
        </div>

        <div>
            <label>Scout Name</label>
            <div class="helper-text">Who is uploading?</div>
            <input type="text" id="uploaderName" placeholder="Your Name">

            <label>Access Password üîí</label>
            <input type="password" id="campPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

            <button class="btn-drive" id="verifyBtn" onclick="verifyAndShowLink()">üìÇ Open Drive Gallery</button>
            <a href="#" id="finalDriveLink" target="_blank" class="success-link" style="display:none">‚úÖ Click to Open Drive</a>
        </div>
    </div>

    <input type="file" id="fileInput" multiple accept="image/*,video/*" style="display:none">
    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <div class="icon-camera">üì∏</div>
        <div style="font-weight:600; letter-spacing:1px; color:var(--text-muted)">TAP TO SELECT MEDIA</div>
    </div>

    <div id="gallery"></div>

    <div class="action-bar">
        <button id="uploadBtn" class="btn-upload" onclick="preCheckAndUpload()">Start Upload</button>
        
        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="progress-text"></div>
    </div>
</div>

<script>
    // -----------------------------------------------------------
    // üî¥ PASTE YOUR NEW WEB APP URL HERE
    // -----------------------------------------------------------
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzal3ftPX0607ZhcjMtKx02LutBiiGnHICsCrMp2EsndaZgQaIpoOtqAw6f9IXPY_wTRQ/exec"; 

    const CONCURRENT_UPLOADS = 3;
    const MAX_SIZE_MB = 30; // Standard script limit

    let currentMode = 'new';
    let fileQueue = [];

    // Init
    window.onload = function() {
        loadFolders();
        document.getElementById('uploadBtn').disabled = true;
        document.getElementById('folderDateInput').valueAsDate = new Date();
    };

    function setMode(mode) {
        currentMode = mode;
        const newGroup = document.getElementById('new-folder-group');
        const existGroup = document.getElementById('existing-folder-group');
        if (mode === 'new') {
            newGroup.style.display = 'block'; existGroup.style.display = 'none';
            document.getElementById('tab-new').classList.add('active');
            document.getElementById('tab-existing').classList.remove('active');
        } else {
            newGroup.style.display = 'none'; existGroup.style.display = 'block';
            document.getElementById('tab-new').classList.remove('active');
            document.getElementById('tab-existing').classList.add('active');
        }
    }

    // --- FILE SELECTION ---
   document.getElementById('fileInput').addEventListener('change', function() {
    const files = Array.from(this.files);
    
    // VALIDATION: Filter out huge files immediately
    const validFiles = files.filter(f => {
        if(f.size > MAX_SIZE_MB * 1024 * 1024) {
            alert(`‚ö†Ô∏è File "${f.name}" is too large! Max size is ${MAX_SIZE_MB}MB.`);
            return false;
        }
        return true;
    });

    if (validFiles.length === 0) return;
    
    // Add valid files to queue
    fileQueue = fileQueue.concat(validFiles);
    renderGallery();
});

    function renderGallery() {
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = "";
        fileQueue.forEach((file, index) => {
            const div = document.createElement('div');
            div.className = 'polaroid';
            div.id = 'thumb-' + index;
            
            // Status Overlay
            const overlay = document.createElement('div');
            overlay.className = 'status-overlay';
            overlay.id = 'status-' + index;
            div.appendChild(overlay);

            if(file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                div.appendChild(img);
            } else {
                div.innerHTML += "<div style='display:flex;align-items:center;justify-content:center;height:100%;font-size:2rem;color:#333'>üé¨</div>";
            }
            gallery.appendChild(div);
        });
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('progress-text').textContent = `${fileQueue.length} files ready`;
    }

    // --- NEW: PRE-CHECK PASSWORD BEFORE UPLOAD ---
    async function preCheckAndUpload() {
        const passwordInput = document.getElementById('campPassword');
        const password = passwordInput.value;
        const btn = document.getElementById('uploadBtn');
        const statusText = document.getElementById('progress-text');

        if (!password) { 
            shakeInput(passwordInput); 
            statusText.textContent = "‚ö†Ô∏è Please enter password";
            statusText.style.color = "var(--error-red)";
            return; 
        }

        // LOCK UI
        btn.disabled = true;
        btn.textContent = "Verifying...";
        statusText.style.color = "var(--text-muted)";
        
        // 1. VERIFY PASSWORD ON SERVER
        try {
            const checkResp = await fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify({ action: "verifyPassword", password: password }),
                headers: { "Content-Type": "text/plain" }
            }).then(r => r.json());

            if (checkResp.result === 'error') {
                // STOP HERE IF PASSWORD IS WRONG
                btn.textContent = "Start Upload";
                btn.disabled = false;
                shakeInput(passwordInput);
                statusText.textContent = "‚õî Incorrect Password. Upload Blocked.";
                statusText.style.color = "var(--error-red)";
                return;
            }

            // 2. IF PASSWORD OK -> START UPLOAD
            btn.textContent = "Uploading...";
            startBatchUpload(password);

        } catch (e) {
            btn.disabled = false;
            btn.textContent = "Retry Upload";
            alert("Connection Error. Check internet.");
        }
    }

    // --- BATCH UPLOADER ---
    async function startBatchUpload(verifiedPassword) {
        const uploader = document.getElementById('uploaderName').value || "Anonymous";
        let folderName = "";

        if (currentMode === 'new') {
            const name = document.getElementById('folderNameInput').value;
            const date = document.getElementById('folderDateInput').value;
            if(!name || !date) { alert("Please enter Folder Name AND Date"); document.getElementById('uploadBtn').disabled = false; return; }
            const [y, m, d] = date.split('-');
            folderName = `${name} - ${d}/${m}/${y}`;
        } else {
            folderName = document.getElementById('existingFolderSelect').value;
            if(!folderName) { alert("Please select a folder!"); document.getElementById('uploadBtn').disabled = false; return; }
        }

        document.getElementById('progress-container').style.display = 'block';
        
        let activeUploads = 0;
        let completed = 0;
        let nextIndex = 0;

        const uploadLoop = () => {
            return new Promise((resolve) => {
                if (nextIndex >= fileQueue.length) { resolve(); return; }

                const index = nextIndex++;
                const file = fileQueue[index];
                
                // SIZE CHECK
                if (file.size > MAX_SIZE_MB * 1024 * 1024) {
                    markError(index);
                    completed++;
                    updateProgress(completed);
                    uploadLoop().then(resolve);
                    return;
                }

                // UI UPDATE
                const overlay = document.getElementById('status-' + index);
                overlay.style.display = 'flex';
                overlay.innerHTML = '<div style="animation:spin 1s linear infinite">‚è≥</div>';

// NEW CODE (Inside uploadLoop)
compressImage(file).then(processed => {
    fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify({
            action: "upload",
            password: verifiedPassword,
            folderType: currentMode,
            folderName: folderName,
            selectedFolder: folderName,
            uploaderName: uploader,
            file: processed.data,      // Compressed Data
            mimeType: processed.type,  // New Mime Type (image/jpeg)
            filename: processed.name   // New Filename (.jpg)
        }),
        headers: { "Content-Type": "text/plain" }
    })
    .then(r => r.json())
    .then(data => {
        if (data.result === 'success') markSuccess(index);
        else markError(index);
    })
    .catch(() => markError(index))
    .finally(() => {
        completed++;
        updateProgress(completed);
        uploadLoop().then(resolve);
    });
});
        };

        const threads = [];
        for (let i = 0; i < CONCURRENT_UPLOADS; i++) threads.push(uploadLoop());
        await Promise.all(threads);
        
        document.getElementById('progress-text').textContent = "üéâ Upload Complete!";
        document.getElementById('uploadBtn').textContent = "Done";
        fileQueue = [];
        loadFolders();
    }

    // --- HELPERS ---
    function updateProgress(completed) {
        const percent = (completed / fileQueue.length) * 100;
        document.getElementById('progress-bar').style.width = percent + "%";
        document.getElementById('progress-text').textContent = `Processed ${completed} of ${fileQueue.length}`;
    }
    function markSuccess(index) {
        const el = document.getElementById('status-' + index);
        el.innerHTML = '‚úÖ';
        document.getElementById('thumb-' + index).classList.add('success');
    }
    function markError(index) {
        const el = document.getElementById('status-' + index);
        el.innerHTML = '‚ùå';
        document.getElementById('thumb-' + index).classList.add('error');
    }
    function shakeInput(input) {
        input.classList.add('shake');
        setTimeout(() => input.classList.remove('shake'), 400);
    }
    function loadFolders() {
        const select = document.getElementById('existingFolderSelect');
        fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getFolders" }),
            headers: { "Content-Type": "text/plain" }
        })
        .then(r => r.json())
        .then(data => {
            if (data.result === 'success') {
                select.innerHTML = '<option value="" disabled selected>Select Folder...</option>';
                data.folders.forEach(f => {
                    let opt = document.createElement("option");
                    opt.text = f; opt.value = f; select.add(opt);
                });
            }
        });
    }
    function verifyAndShowLink() {
        const password = document.getElementById('campPassword').value;
        const btn = document.getElementById('verifyBtn');
        if (!password) { shakeInput(document.getElementById('campPassword')); return; }

        btn.textContent = "Verifying...";
        fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getDriveLink", password: password }),
            headers: { "Content-Type": "text/plain" }
        }).then(r => r.json()).then(data => {
            if(data.result === 'success') {
                document.getElementById('finalDriveLink').href = data.url;
                document.getElementById('finalDriveLink').style.display = 'block';
                btn.textContent = "Verified!";
                btn.style.borderColor = "var(--success-green)";
                btn.style.color = "var(--success-green)";
            } else {
                alert("Incorrect Password");
                btn.textContent = "üìÇ Open Drive Gallery";
                shakeInput(document.getElementById('campPassword'));
            }
        });
    }

    // --- NEW: COMPRESSION HELPER ---
function compressImage(file) {
    return new Promise((resolve) => {
        // If not an image (e.g. video), return original file
        if (!file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => resolve({ 
                data: e.target.result.split(',')[1], 
                name: file.name, 
                type: file.type 
            });
            reader.readAsDataURL(file);
            return;
        }

        // If Image -> Compress
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
// --- CHANGE 1: Higher Resolution Limit ---
            // 2560px is "2K" resolution. Sharp enough for full-screen on laptops.
            const MAX_DIM = 2560; 
            
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > MAX_DIM) { height *= MAX_DIM / width; width = MAX_DIM; }
            } else {
                if (height > MAX_DIM) { width *= MAX_DIM / height; height = MAX_DIM; }
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

// --- CHANGE 2: Higher JPEG Quality ---
            // 0.9 (90%) keeps almost all detail.
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            
            resolve({ 
                data: dataUrl.split(',')[1], 
                name: file.name.replace(/\.[^/.]+$/, "") + ".jpg", // Force extension to jpg
                type: 'image/jpeg' 
            });
        };
    });
}
</script>

</body>
</html>
